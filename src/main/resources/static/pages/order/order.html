<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>주문 관리</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="d-flex flex-column" style="min-height: 100vh;">

	<!-- ✅ 공통 레이아웃 -->
	<div id="header"></div>
	<div class="d-flex flex-grow-1">
		<div id="sidebar"></div>
		<main class="p-4 flex-fill">
			<div class="container">
				<h2 class="mb-4">주문 관리</h2>

				<!-- 🔍 검색 및 버튼 -->
				<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
					<input type="text" class="form-control w-auto" placeholder="고객사명" />
					<input type="date" class="form-control w-auto" /> <span
						class="align-self-center">~</span> <input type="date"
						class="form-control w-auto" />
					<button class="btn btn-outline-secondary">검색</button>
					<button class="btn btn-outline-success ms-auto">엑셀 다운로드</button>
					<button class="btn btn-danger">삭제</button>
					<!-- 등록 버튼 -->
					<button class="btn btn-primary" onclick="openOrderAddModal()"
						data-bs-toggle="modal" data-bs-target="#orderRegisterModal">+
						주문 등록</button>
				</div>

				<!-- 📋 주문 테이블 -->
				<div class="table-responsive">
					<table class="table table-bordered text-center align-middle">
						<thead class="table-light">
							<tr>
								<th><input type="checkbox" /></th>
								<th>순번</th>
								<th>주문일자</th>
								<th>주문번호</th>
								<th>고객사</th>
								<th>납기일자</th>
								<th>품목수</th>
								<th>총금액</th>
								<th>담당자</th>
								<th>비고</th>
								<th>상세</th>
								<th>수정</th>
								<th>출고등록</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><input type="checkbox" /></td>
								<td>1</td>
								<td>2025-05-20</td>
								<td>ORD202405001</td>
								<td>삼성전자</td>
								<td>2025-06-01</td>
								<td>2</td>
								<td>1,200,000</td>
								<td>김인호</td>
								<td>-</td>
								<td>
									<button class="btn btn-info btn-sm"
										onclick='openOrderDetailModal({
                    customer: "삼성전자",
                    order_date: "2025-05-20",
                    due_date: "2025-06-01",
                    manager: "김인호",
                    note: "-",
                    items: [
                      { item_code: "P001", item_name: "완제품 A", quantity: 100, unit: "EA", unit_price: 5000 },
                      { item_code: "P002", item_name: "완제품 B", quantity: 50, unit: "EA", unit_price: 8000 }
                    ]
                  })'>상세</button>
								</td>
								<td>
									<button class="btn btn-warning btn-sm"
										onclick='openOrderEditModal({
                    id: 1,
                    customer_id: "1",
                    order_date: "2025-05-20",
                    due_date: "2025-06-01",
                    manager: "김인호",
                    note: "-",
                    items: [
                      { item_id: "P001", quantity: 100, unit: "EA", unit_price: 5000 },
                      { item_id: "P002", quantity: 50, unit: "EA", unit_price: 8000 }
                    ]
                  })'>수정</button>
								</td>
								<!-- 주문 테이블 내 수정/상세 옆에 추가 -->
								<td>
									<button class="btn btn-success btn-sm"
										onclick='openShipmentFromOrder({
											customer_id: "1",  // 🔸 이걸 사용해야 함
										    manager: "김인호",
										    items: [
										      { item_id: "P001", item_name: "완제품 A", qty: 100, unit: "EA" },
										      { item_id: "P002", item_name: "완제품 B", qty: 50, unit: "EA" }
										    ]
										  })'>출고등록</button>
								</td>

							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</main>
	</div>

	<!-- ✅ 모달 영역 -->
	<!-- 출고 등록 모달을 삽입할 위치 -->
	<div id="shipmentModals"></div>

	<div id="orderModals"></div>
	<div id="orderDetailModalWrapper"></div>
	<div id="footer"></div>

	<!-- ✅ 공통 컴포넌트 fetch -->
	<script>
    fetch('/layouts/header.html').then(res => res.text()).then(html => document.getElementById('header').innerHTML = html);
    fetch('/layouts/sidebar.html').then(res => res.text()).then(html => document.getElementById('sidebar').innerHTML = html);
    fetch('/layouts/footer.html').then(res => res.text()).then(html => document.getElementById('footer').innerHTML = html);

    fetch('/pages/order/order-register-modal.html')
      .then(res => res.text())
      .then(html => document.getElementById('orderModals').innerHTML = html);

    fetch('/pages/order/order-detail-modal.html')
      .then(res => res.text())
      .then(html => document.getElementById('orderDetailModalWrapper').innerHTML = html);
  </script>

	<!-- ✅ 상세 보기 모달 호출 -->
	<script>
    function openOrderDetailModal(order) {
      if (!document.getElementById('orderDetailModal')) {
        fetch('/pages/order/order-detail-modal.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('orderDetailModalWrapper').innerHTML = html;
            setTimeout(() => openOrderDetailModal(order), 100);
          });
        return;
      }

      document.getElementById('detailCustomer').textContent = order.customer;
      document.getElementById('detailOrderDate').textContent = order.order_date;
      document.getElementById('detailDueDate').textContent = order.due_date;
      document.getElementById('detailManager').textContent = order.manager;
      document.getElementById('detailNote').textContent = order.note;

      const tbody = document.getElementById('orderDetailItems');
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.item_code}</td>
          <td>${item.item_name}</td>
          <td>${item.quantity}</td>
          <td>${item.unit}</td>
          <td>${Number(item.unit_price).toLocaleString()}</td>
          <td>${(item.quantity * item.unit_price).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });

      const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
      modal.show();
    }
  </script>

	<!-- ✅ 수정 모드 -->
	<script>
    function openOrderEditModal(order) {
      if (!document.getElementById('orderRegisterModal')) {
        fetch('/pages/order/order-register-modal.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('orderModals').innerHTML = html;
            setTimeout(() => openOrderEditModal(order), 100);
          });
        return;
      }

      document.querySelector('[name="customer_id"]').value = order.customer_id;
      document.querySelector('[name="order_date"]').value = order.order_date;
      document.querySelector('[name="due_date"]').value = order.due_date;
      document.querySelector('[name="manager"]').value = order.manager;
      document.querySelector('[name="note"]').value = order.note;

      const tbody = document.querySelector("#orderItemTable tbody");
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <select class="form-select" name="item_id[]" required>
              <option value="">-- 선택 --</option>
              <option value="P001">P001 - 완제품 A</option>
              <option value="P002">P002 - 완제품 B</option>
            </select>
          </td>
          <td><input type="number" name="quantity[]" class="form-control" value="${item.quantity}" required oninput="calculateRowTotal(this)" /></td>
          <td><input type="text" name="unit[]" class="form-control" value="${item.unit}" required /></td>
          <td><input type="number" name="unit_price[]" class="form-control" value="${item.unit_price}" required oninput="calculateRowTotal(this)" /></td>
          <td><input type="text" class="form-control total" readonly value="${(item.quantity * item.unit_price).toLocaleString()}" /></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItemRow(this)">삭제</button></td>
        `;
        tbody.appendChild(row);
        row.querySelector('select[name="item_id[]"]').value = item.item_id;
      });

      document.getElementById("orderForm").action = `/order/update/${order.id}`;
      document.getElementById("submitBtn").textContent = "수정";

      const modal = new bootstrap.Modal(document.getElementById('orderRegisterModal'));
      modal.show();
    }
    function openOrderAddModal() {
    	  if (!document.getElementById('orderRegisterModal')) return;

    	  const form = document.getElementById('orderForm');
    	  if (form) {
    	    form.reset();
    	    form.action = '/order/add';
    	  }
    	  document.getElementById('submitBtn').textContent = '등록';

    	  // 품목 테이블 초기화 (기본 한 줄)
    	  const tbody = document.querySelector("#orderItemTable tbody");
    	  tbody.innerHTML = `
    	    <tr>
    	      <td>
    	        <select class="form-select" name="item_id[]" required>
    	          <option value="">-- 선택 --</option>
    	          <option value="P001">P001 - 완제품 A</option>
    	          <option value="P002">P002 - 완제품 B</option>
    	        </select>
    	      </td>
    	      <td><input type="number" name="quantity[]" class="form-control" required oninput="calculateRowTotal(this)" /></td>
    	      <td><input type="text" name="unit[]" class="form-control" value="EA" required /></td>
    	      <td><input type="number" name="unit_price[]" class="form-control" required oninput="calculateRowTotal(this)" /></td>
    	      <td><input type="text" class="form-control total" readonly value="0" /></td>
    	      <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItemRow(this)">삭제</button></td>
    	    </tr>
    	  `;
    	}
  </script>
	<!-- 수정, 추가 버튼에서 작동하는 주문 품목 동적 처리 스크립트 -->
	<script>
  function addOrderItemRow() {
    const tbody = document.querySelector("#orderItemTable tbody");
    const newRow = tbody.rows[0].cloneNode(true);

    // 입력값 초기화
    newRow.querySelectorAll("input").forEach(input => {
      input.value = input.name.includes("unit") ? "EA" : "";
    });

    tbody.appendChild(newRow);
  }

  function removeOrderItemRow(button) {
    const row = button.closest("tr");
    const table = document.querySelector("#orderItemTable tbody");
    if (table.rows.length > 1) row.remove();
    else alert("최소 1개 품목은 필요합니다.");
  }

  function calculateRowTotal(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.querySelector("input[name='quantity[]']").value) || 0;
    const price = parseFloat(row.querySelector("input[name='unit_price[]']").value) || 0;
    row.querySelector(".total").value = (qty * price).toLocaleString();
  }
</script>
	<script>
	function openShipmentFromOrder(order) {
		  // 1. shipment-register-modal이 없으면 fetch로 불러오고, 있으면 바로 데이터 주입
		  if (!document.getElementById('shipmentRegisterModal')) {
		    const modalWrap = document.getElementById('shipmentModals');
		    if (!modalWrap) {
		      alert('shipmentModals div가 없습니다! order.html의 <body> 내 <div id="shipmentModals"></div>를 확인하세요.');
		      return;
		    }
		    fetch('/pages/shipment/shipment-register-modal.html')
		      .then(res => res.text())
		      .then(html => {
		        modalWrap.innerHTML = html;
		        setTimeout(() => openShipmentFromOrder(order), 100);
		      });
		    return;
		  }

		  // 2. 모달에 값 넣기 (order 예시 데이터 기반)
		  document.getElementById('customerId').value = order.customer_id;
		  document.getElementById('manager').value = order.manager;

		  // 3. 품목 테이블 채우기
		  // (여러 품목이라면 반복문으로 row 추가)
		  const tbody = document.getElementById('shipmentItemTableBody');
		  if (tbody) {
		    tbody.innerHTML = '';
		    order.items.forEach(item => {
		      const row = document.createElement('tr');
		      row.innerHTML = `
		        <td><input type="text" class="form-control" value="${item.item_id}" readonly /></td>
		        <td><input type="text" class="form-control" value="${item.item_name}" readonly /></td>
		        <td><input type="number" class="form-control" value="${item.qty}" required /></td>
		        <td><input type="text" class="form-control" value="${item.unit}" readonly /></td>
		      `;
		      tbody.appendChild(row);
		    });
		  }

		  // 4. 모달 열기
		  const modal = new bootstrap.Modal(document.getElementById('shipmentRegisterModal'));
		  modal.show();
		}


</script>


</body>
</html>
