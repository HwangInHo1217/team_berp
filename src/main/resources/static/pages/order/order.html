<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì£¼ë¬¸ ê´€ë¦¬</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="d-flex flex-column" style="min-height: 100vh;">

	<!-- âœ… ê³µí†µ ë ˆì´ì•„ì›ƒ -->
	<div id="header"></div>
	<div class="d-flex flex-grow-1">
		<div id="sidebar"></div>
		<main class="p-4 flex-fill">
			<div class="container">
				<h2 class="mb-4">ì£¼ë¬¸ ê´€ë¦¬</h2>

				<!-- ğŸ” ê²€ìƒ‰ ë° ë²„íŠ¼ -->
				<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
					<input type="text" class="form-control w-auto" placeholder="ê³ ê°ì‚¬ëª…" />
					<input type="date" class="form-control w-auto" /> <span
						class="align-self-center">~</span> <input type="date"
						class="form-control w-auto" />
					<button class="btn btn-outline-secondary">ê²€ìƒ‰</button>
					<button class="btn btn-outline-success ms-auto">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
					<button class="btn btn-danger">ì‚­ì œ</button>
					<!-- ë“±ë¡ ë²„íŠ¼ -->
					<button class="btn btn-primary" onclick="openOrderAddModal()"
						data-bs-toggle="modal" data-bs-target="#orderRegisterModal">+
						ì£¼ë¬¸ ë“±ë¡</button>
				</div>

				<!-- ğŸ“‹ ì£¼ë¬¸ í…Œì´ë¸” -->
				<div class="table-responsive">
					<table class="table table-bordered text-center align-middle">
						<thead class="table-light">
							<tr>
								<th><input type="checkbox" /></th>
								<th>ìˆœë²ˆ</th>
								<th>ì£¼ë¬¸ì¼ì</th>
								<th>ì£¼ë¬¸ë²ˆí˜¸</th>
								<th>ê³ ê°ì‚¬</th>
								<th>ë‚©ê¸°ì¼ì</th>
								<th>í’ˆëª©ìˆ˜</th>
								<th>ì´ê¸ˆì•¡</th>
								<th>ë‹´ë‹¹ì</th>
								<th>ë¹„ê³ </th>
								<th>ìƒì„¸</th>
								<th>ìˆ˜ì •</th>
								<th>ì¶œê³ ë“±ë¡</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><input type="checkbox" /></td>
								<td>1</td>
								<td>2025-05-20</td>
								<td>ORD202405001</td>
								<td>ì‚¼ì„±ì „ì</td>
								<td>2025-06-01</td>
								<td>2</td>
								<td>1,200,000</td>
								<td>ê¹€ì¸í˜¸</td>
								<td>-</td>
								<td>
									<button class="btn btn-info btn-sm"
										onclick='openOrderDetailModal({
                    customer: "ì‚¼ì„±ì „ì",
                    order_date: "2025-05-20",
                    due_date: "2025-06-01",
                    manager: "ê¹€ì¸í˜¸",
                    note: "-",
                    items: [
                      { item_code: "P001", item_name: "ì™„ì œí’ˆ A", quantity: 100, unit: "EA", unit_price: 5000 },
                      { item_code: "P002", item_name: "ì™„ì œí’ˆ B", quantity: 50, unit: "EA", unit_price: 8000 }
                    ]
                  })'>ìƒì„¸</button>
								</td>
								<td>
									<button class="btn btn-warning btn-sm"
										onclick='openOrderEditModal({
                    id: 1,
                    customer_id: "1",
                    order_date: "2025-05-20",
                    due_date: "2025-06-01",
                    manager: "ê¹€ì¸í˜¸",
                    note: "-",
                    items: [
                      { item_id: "P001", quantity: 100, unit: "EA", unit_price: 5000 },
                      { item_id: "P002", quantity: 50, unit: "EA", unit_price: 8000 }
                    ]
                  })'>ìˆ˜ì •</button>
								</td>
								<!-- ì£¼ë¬¸ í…Œì´ë¸” ë‚´ ìˆ˜ì •/ìƒì„¸ ì˜†ì— ì¶”ê°€ -->
								<td>
									<button class="btn btn-success btn-sm"
										onclick='openShipmentFromOrder({
											customer_id: "1",  // ğŸ”¸ ì´ê±¸ ì‚¬ìš©í•´ì•¼ í•¨
										    manager: "ê¹€ì¸í˜¸",
										    items: [
										      { item_id: "P001", item_name: "ì™„ì œí’ˆ A", qty: 100, unit: "EA" },
										      { item_id: "P002", item_name: "ì™„ì œí’ˆ B", qty: 50, unit: "EA" }
										    ]
										  })'>ì¶œê³ ë“±ë¡</button>
								</td>

							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</main>
	</div>

	<!-- âœ… ëª¨ë‹¬ ì˜ì—­ -->
	<!-- ì¶œê³  ë“±ë¡ ëª¨ë‹¬ì„ ì‚½ì…í•  ìœ„ì¹˜ -->
	<div id="shipmentModals"></div>

	<div id="orderModals"></div>
	<div id="orderDetailModalWrapper"></div>
	<div id="footer"></div>

	<!-- âœ… ê³µí†µ ì»´í¬ë„ŒíŠ¸ fetch -->
	<script>
    fetch('/layouts/header.html').then(res => res.text()).then(html => document.getElementById('header').innerHTML = html);
    fetch('/layouts/sidebar.html').then(res => res.text()).then(html => document.getElementById('sidebar').innerHTML = html);
    fetch('/layouts/footer.html').then(res => res.text()).then(html => document.getElementById('footer').innerHTML = html);

    fetch('/pages/order/order-register-modal.html')
      .then(res => res.text())
      .then(html => document.getElementById('orderModals').innerHTML = html);

    fetch('/pages/order/order-detail-modal.html')
      .then(res => res.text())
      .then(html => document.getElementById('orderDetailModalWrapper').innerHTML = html);
  </script>

	<!-- âœ… ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ í˜¸ì¶œ -->
	<script>
    function openOrderDetailModal(order) {
      if (!document.getElementById('orderDetailModal')) {
        fetch('/pages/order/order-detail-modal.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('orderDetailModalWrapper').innerHTML = html;
            setTimeout(() => openOrderDetailModal(order), 100);
          });
        return;
      }

      document.getElementById('detailCustomer').textContent = order.customer;
      document.getElementById('detailOrderDate').textContent = order.order_date;
      document.getElementById('detailDueDate').textContent = order.due_date;
      document.getElementById('detailManager').textContent = order.manager;
      document.getElementById('detailNote').textContent = order.note;

      const tbody = document.getElementById('orderDetailItems');
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.item_code}</td>
          <td>${item.item_name}</td>
          <td>${item.quantity}</td>
          <td>${item.unit}</td>
          <td>${Number(item.unit_price).toLocaleString()}</td>
          <td>${(item.quantity * item.unit_price).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });

      const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
      modal.show();
    }
  </script>

	<!-- âœ… ìˆ˜ì • ëª¨ë“œ -->
	<script>
    function openOrderEditModal(order) {
      if (!document.getElementById('orderRegisterModal')) {
        fetch('/pages/order/order-register-modal.html')
          .then(res => res.text())
          .then(html => {
            document.getElementById('orderModals').innerHTML = html;
            setTimeout(() => openOrderEditModal(order), 100);
          });
        return;
      }

      document.querySelector('[name="customer_id"]').value = order.customer_id;
      document.querySelector('[name="order_date"]').value = order.order_date;
      document.querySelector('[name="due_date"]').value = order.due_date;
      document.querySelector('[name="manager"]').value = order.manager;
      document.querySelector('[name="note"]').value = order.note;

      const tbody = document.querySelector("#orderItemTable tbody");
      tbody.innerHTML = '';
      order.items.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <select class="form-select" name="item_id[]" required>
              <option value="">-- ì„ íƒ --</option>
              <option value="P001">P001 - ì™„ì œí’ˆ A</option>
              <option value="P002">P002 - ì™„ì œí’ˆ B</option>
            </select>
          </td>
          <td><input type="number" name="quantity[]" class="form-control" value="${item.quantity}" required oninput="calculateRowTotal(this)" /></td>
          <td><input type="text" name="unit[]" class="form-control" value="${item.unit}" required /></td>
          <td><input type="number" name="unit_price[]" class="form-control" value="${item.unit_price}" required oninput="calculateRowTotal(this)" /></td>
          <td><input type="text" class="form-control total" readonly value="${(item.quantity * item.unit_price).toLocaleString()}" /></td>
          <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItemRow(this)">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(row);
        row.querySelector('select[name="item_id[]"]').value = item.item_id;
      });

      document.getElementById("orderForm").action = `/order/update/${order.id}`;
      document.getElementById("submitBtn").textContent = "ìˆ˜ì •";

      const modal = new bootstrap.Modal(document.getElementById('orderRegisterModal'));
      modal.show();
    }
    function openOrderAddModal() {
    	  if (!document.getElementById('orderRegisterModal')) return;

    	  const form = document.getElementById('orderForm');
    	  if (form) {
    	    form.reset();
    	    form.action = '/order/add';
    	  }
    	  document.getElementById('submitBtn').textContent = 'ë“±ë¡';

    	  // í’ˆëª© í…Œì´ë¸” ì´ˆê¸°í™” (ê¸°ë³¸ í•œ ì¤„)
    	  const tbody = document.querySelector("#orderItemTable tbody");
    	  tbody.innerHTML = `
    	    <tr>
    	      <td>
    	        <select class="form-select" name="item_id[]" required>
    	          <option value="">-- ì„ íƒ --</option>
    	          <option value="P001">P001 - ì™„ì œí’ˆ A</option>
    	          <option value="P002">P002 - ì™„ì œí’ˆ B</option>
    	        </select>
    	      </td>
    	      <td><input type="number" name="quantity[]" class="form-control" required oninput="calculateRowTotal(this)" /></td>
    	      <td><input type="text" name="unit[]" class="form-control" value="EA" required /></td>
    	      <td><input type="number" name="unit_price[]" class="form-control" required oninput="calculateRowTotal(this)" /></td>
    	      <td><input type="text" class="form-control total" readonly value="0" /></td>
    	      <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOrderItemRow(this)">ì‚­ì œ</button></td>
    	    </tr>
    	  `;
    	}
  </script>
	<!-- ìˆ˜ì •, ì¶”ê°€ ë²„íŠ¼ì—ì„œ ì‘ë™í•˜ëŠ” ì£¼ë¬¸ í’ˆëª© ë™ì  ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
	<script>
  function addOrderItemRow() {
    const tbody = document.querySelector("#orderItemTable tbody");
    const newRow = tbody.rows[0].cloneNode(true);

    // ì…ë ¥ê°’ ì´ˆê¸°í™”
    newRow.querySelectorAll("input").forEach(input => {
      input.value = input.name.includes("unit") ? "EA" : "";
    });

    tbody.appendChild(newRow);
  }

  function removeOrderItemRow(button) {
    const row = button.closest("tr");
    const table = document.querySelector("#orderItemTable tbody");
    if (table.rows.length > 1) row.remove();
    else alert("ìµœì†Œ 1ê°œ í’ˆëª©ì€ í•„ìš”í•©ë‹ˆë‹¤.");
  }

  function calculateRowTotal(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.querySelector("input[name='quantity[]']").value) || 0;
    const price = parseFloat(row.querySelector("input[name='unit_price[]']").value) || 0;
    row.querySelector(".total").value = (qty * price).toLocaleString();
  }
</script>
	<script>
	function openShipmentFromOrder(order) {
		  // 1. shipment-register-modalì´ ì—†ìœ¼ë©´ fetchë¡œ ë¶ˆëŸ¬ì˜¤ê³ , ìˆìœ¼ë©´ ë°”ë¡œ ë°ì´í„° ì£¼ì…
		  if (!document.getElementById('shipmentRegisterModal')) {
		    const modalWrap = document.getElementById('shipmentModals');
		    if (!modalWrap) {
		      alert('shipmentModals divê°€ ì—†ìŠµë‹ˆë‹¤! order.htmlì˜ <body> ë‚´ <div id="shipmentModals"></div>ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
		      return;
		    }
		    fetch('/pages/shipment/shipment-register-modal.html')
		      .then(res => res.text())
		      .then(html => {
		        modalWrap.innerHTML = html;
		        setTimeout(() => openShipmentFromOrder(order), 100);
		      });
		    return;
		  }

		  // 2. ëª¨ë‹¬ì— ê°’ ë„£ê¸° (order ì˜ˆì‹œ ë°ì´í„° ê¸°ë°˜)
		  document.getElementById('customerId').value = order.customer_id;
		  document.getElementById('manager').value = order.manager;

		  // 3. í’ˆëª© í…Œì´ë¸” ì±„ìš°ê¸°
		  // (ì—¬ëŸ¬ í’ˆëª©ì´ë¼ë©´ ë°˜ë³µë¬¸ìœ¼ë¡œ row ì¶”ê°€)
		  const tbody = document.getElementById('shipmentItemTableBody');
		  if (tbody) {
		    tbody.innerHTML = '';
		    order.items.forEach(item => {
		      const row = document.createElement('tr');
		      row.innerHTML = `
		        <td><input type="text" class="form-control" value="${item.item_id}" readonly /></td>
		        <td><input type="text" class="form-control" value="${item.item_name}" readonly /></td>
		        <td><input type="number" class="form-control" value="${item.qty}" required /></td>
		        <td><input type="text" class="form-control" value="${item.unit}" readonly /></td>
		      `;
		      tbody.appendChild(row);
		    });
		  }

		  // 4. ëª¨ë‹¬ ì—´ê¸°
		  const modal = new bootstrap.Modal(document.getElementById('shipmentRegisterModal'));
		  modal.show();
		}


</script>


</body>
</html>
